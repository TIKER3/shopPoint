<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™´ã‚Œã‚‹å±‹ãƒã‚¤ãƒ³ãƒˆå±¥æ­´é›†è¨ˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 20px; border-bottom: 2px solid #ea2d2d; padding-bottom: 10px; }
        
        /* Input Section */
        .input-section { margin-bottom: 20px; padding: 15px; background: #fafafa; border: 1px dashed #ccc; border-radius: 5px; }
        .input-section p { margin-top: 0; font-weight: bold; color: #555; }
        textarea { width: 100%; height: 100px; margin-top: 5px; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
        
        .btn-group { margin-top: 10px; display: flex; gap: 10px; }
        button { background-color: #ea2d2d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #c92222; }
        button.secondary { background-color: #6c757d; }
        button.outline { background-color: transparent; border: 1px solid #ea2d2d; color: #ea2d2d; }
        button.outline:hover { background-color: #fff0f0; }
        
        /* Dashboard */
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .card { background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #eee; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px; font-size: 14px; color: #666; }
        .card .value { font-size: 24px; font-weight: bold; }
        .plus { color: #28a745; }
        .minus { color: #dc3545; }

        @media (max-width: 600px) {
            .dashboard { grid-template-columns: 1fr 1fr; }
            .card .value { font-size: 18px; }
            .card { padding: 10px; }
            .report-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .report-controls { width: 100%; display: flex; gap: 5px; }
            .report-controls select { flex: 1; }
        }

        /* Monthly Report Section */
        #monthlySection {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            background: #fff;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .report-header h3 { margin: 0; font-size: 18px; color: #444; }
        .report-controls { display: flex; gap: 10px; }

        /* Filters */
        .filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; background: #eee; padding: 10px; border-radius: 5px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f8f8; font-weight: bold; }
        .num { text-align: right; }
        .tag { padding: 2px 6px; border-radius: 3px; font-size: 12px; color: white; display: inline-block; }
        .tag-store { background-color: #17a2b8; }
        .tag-tc { background-color: #007bff; }
        .tag-event { background-color: #ffc107; color: #333; }
        .tag-use { background-color: #dc3545; }
        .tag-other { background-color: #6c757d; }

        /* Monthly Table Specifics */
        .monthly-table th { background-color: #ea2d2d; color: white; }
        .monthly-table tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ™´ã‚Œã‚‹å±‹ ãƒã‚¤ãƒ³ãƒˆå±¥æ­´é›†è¨ˆ</h1>

    <div class="input-section">
        <p>ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿</p>
        <div style="font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.6;">
            <strong>ã€é‡è¦ã€‘ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã”åˆ©ç”¨ã®æ–¹ã¸</strong><br>
            ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç‰ˆã®è¡¨ç¤ºã§ã¯æ­£ã—ãã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
            ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰<span style="color: #ea2d2d; font-weight: bold;">ã€ŒPCç‰ˆã‚µã‚¤ãƒˆã€</span>ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‹ã‚‰ã€å±¥æ­´ã®æ–‡å­—ã‚’å…¨ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚<br>
        </div>
        <textarea id="rawInput" placeholder='ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘...'></textarea>
        <div class="btn-group">
            <button onclick="processData(true)">é›†è¨ˆã™ã‚‹</button>
            <button class="secondary" onclick="clearData()">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="card">
            <h3>ç²å¾—åˆè¨ˆ</h3>
            <div class="value plus" id="totalGained">0 pt</div>
        </div>
        <div class="card">
            <h3>åˆ©ç”¨åˆè¨ˆ</h3>
            <div class="value minus" id="totalUsed">0 pt</div>
        </div>
        <div class="card">
            <h3>åæ”¯</h3>
            <div class="value" id="netBalance">0 pt</div>
        </div>
        <div class="card">
            <h3>ä»¶æ•°</h3>
            <div class="value" id="recordCount">0 ä»¶</div>
        </div>
    </div>

    <div style="margin-bottom: 20px; text-align: right;">
        <button class="outline" onclick="toggleMonthlySection()">ğŸ“Š æœˆåˆ¥é›†è¨ˆã‚’è¡¨ç¤º</button>
    </div>

    <div id="monthlySection">
        <div class="report-header">
            <h3>æœˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <div class="report-controls">
                <select id="monthlyYearSelect" onchange="renderMonthlyTable()">
                    </select>
                <select id="monthlyTypeFilter" onchange="renderMonthlyTable()">
                    <option value="all">å…¨ã¦ã®åˆ†é¡</option>
                    <option value="TC">é€šè²©/TCæ³¨æ–‡</option>
                    <option value="STORE">åº—èˆ—è³¼å…¥</option>
                    <option value="EVENT">å¤§ä¼šå‚åŠ </option>
                    <option value="USE">ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨</option>
                </select>
            </div>
        </div>
        <table class="monthly-table">
            <thead>
                <tr>
                    <th>æœˆ</th>
                    <th class="num">ç²å¾— (+)</th>
                    <th class="num">åˆ©ç”¨ (-)</th>
                    <th class="num">åæ”¯</th>
                </tr>
            </thead>
            <tbody id="monthlyTableBody">
                </tbody>
        </table>
    </div>

    <div class="filters">
        <label>å±¥æ­´ãƒªã‚¹ãƒˆçµã‚Šè¾¼ã¿:</label>
        <select id="yearFilter" onchange="applyFilters()">
            <option value="all">å…¨ã¦ã®æœŸé–“</option>
        </select>
        <select id="typeFilter" onchange="applyFilters()">
            <option value="all">å…¨ã¦ã®åˆ†é¡</option>
            <option value="TC">é€šè²©/TCæ³¨æ–‡</option>
            <option value="STORE">åº—èˆ—è³¼å…¥</option>
            <option value="EVENT">å¤§ä¼šå‚åŠ </option>
            <option value="USE">ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨</option>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th>æ—¥ä»˜</th>
                <th>åˆ†é¡</th>
                <th>å‚™è€ƒ / è©³ç´°</th>
                <th>æ³¨æ–‡ç•ªå·</th>
                <th class="num">ãƒã‚¤ãƒ³ãƒˆ</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let allData = [];
    const STORAGE_KEY = 'hareruya_point_history_data';

    window.addEventListener('DOMContentLoaded', () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            document.getElementById('rawInput').value = savedData;
            processData(false);
        }
    });

    function processData(showAlert = true) {
        const rawText = document.getElementById('rawInput').value;
        if (!rawText.trim()) {
            if (showAlert) alert("ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        localStorage.setItem(STORAGE_KEY, rawText);

        // ãƒ†ã‚­ã‚¹ãƒˆè§£æã‚’å®Ÿè¡Œ
        allData = parseRawText(rawText);

        setupYearFilter(allData);
        setupMonthlyYearSelect(allData); // æœˆåˆ¥ç”¨ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
        applyFilters();
        
        // ã‚‚ã—æœˆåˆ¥é›†è¨ˆãŒé–‹ã„ã¦ã„ãŸã‚‰æ›´æ–°ã™ã‚‹
        if(document.getElementById('monthlySection').style.display === 'block'){
            renderMonthlyTable();
        }
    }

    function clearData() {
        if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            document.getElementById('rawInput').value = '';
            localStorage.removeItem(STORAGE_KEY);
            allData = [];
            document.getElementById('tableBody').innerHTML = '';
            updateDashboard([]);
            setupYearFilter([]);
            setupMonthlyYearSelect([]);
            document.getElementById('monthlySection').style.display = 'none';
        }
    }

    // æœˆåˆ¥é›†è¨ˆã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleMonthlySection() {
        const section = document.getElementById('monthlySection');
        const isHidden = section.style.display === 'none' || section.style.display === '';
        
        if (isHidden) {
            section.style.display = 'block';
            renderMonthlyTable(); // è¡¨ç¤ºæ™‚ã«è¨ˆç®—
        } else {
            section.style.display = 'none';
        }
    }

    // æœˆåˆ¥ç”¨å¹´åº¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupMonthlyYearSelect(data) {
        const years = [...new Set(data.map(d => d.year))].sort((a, b) => b - a);
        const select = document.getElementById('monthlyYearSelect');
        const currentVal = select.value;
        
        select.innerHTML = '';
        if(years.length === 0) {
            const op = document.createElement('option');
            op.text = "ãƒ‡ãƒ¼ã‚¿ãªã—";
            select.appendChild(op);
            return;
        }

        years.forEach(y => {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = y + 'å¹´';
            select.appendChild(option);
        });

        // ä»¥å‰é¸æŠã—ã¦ã„ãŸå€¤ãŒã‚ã‚Œã°ç¶­æŒã€ãªã‘ã‚Œã°æœ€æ–°å¹´
        if (years.some(y => y.toString() === currentVal)) {
            select.value = currentVal;
        } else if (years.length > 0) {
            select.value = years[0];
        }
    }

    // æœˆåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
    function renderMonthlyTable() {
        const yearSelect = document.getElementById('monthlyYearSelect');
        const typeSelect = document.getElementById('monthlyTypeFilter');
        
        const year = parseInt(yearSelect.value);
        const type = typeSelect.value;
        
        if (isNaN(year)) return;

        // 1æœˆã€œ12æœˆã®æ ã‚’ä½œã‚‹
        const monthlyData = {};
        for(let i=1; i<=12; i++) {
            monthlyData[i] = { gained: 0, used: 0 };
        }

        // è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        allData.forEach(d => {
            // å¹´ã®ä¸€è‡´ç¢ºèª
            const isYearMatch = d.year === year;
            // åˆ†é¡ã®ä¸€è‡´ç¢ºèª (allãªã‚‰å…¨ã¦OK)
            const isTypeMatch = type === 'all' || d.type === type;

            if (isYearMatch && isTypeMatch) {
                if (d.points > 0) {
                    monthlyData[d.month].gained += d.points;
                } else {
                    monthlyData[d.month].used += Math.abs(d.points);
                }
            }
        });

        const tbody = document.getElementById('monthlyTableBody');
        tbody.innerHTML = '';

        // 12ãƒ¶æœˆåˆ†ãƒ«ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
        for(let i=1; i<=12; i++) {
            const m = monthlyData[i];
            const net = m.gained - m.used;
            
            const tr = document.createElement('tr');
            
            const netClass = net > 0 ? 'plus' : (net < 0 ? 'minus' : '');
            const netSign = net > 0 ? '+' : '';

            tr.innerHTML = `
                <td><strong>${i}æœˆ</strong></td>
                <td class="num plus">${m.gained > 0 ? '+' + m.gained.toLocaleString() : '-'}</td>
                <td class="num minus">${m.used > 0 ? '-' + m.used.toLocaleString() : '-'}</td>
                <td class="num ${netClass}"><strong>${net !== 0 ? netSign + net.toLocaleString() : '-'}</strong></td>
            `;
            tbody.appendChild(tr);
        }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆè§£æãƒ­ã‚¸ãƒƒã‚¯
    function parseRawText(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
        const records = [];
        let currentRecord = null;
        const dateRegex = /^(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/;
        const pointRegex = /^([+-])([0-9,]+)$/;
        const orderIdRegex = /^\d{7,}$/; 

        const pushRecord = (rec) => {
            if (rec && rec.pointsStr) { 
                rec.points = parseInt(rec.pointsStr.replace(/,/g, ''), 10);
                if (isNaN(rec.points)) return;
                if (rec.points < 0) { rec.type = 'USE'; rec.typeName = 'åˆ©ç”¨'; } 
                else if (rec.remarks.includes('Point Granter')) { rec.type = 'EVENT'; rec.typeName = 'å¤§ä¼šå‚åŠ '; } 
                else if (rec.remarks.includes('åº—èˆ—ä»˜ä¸')) { rec.type = 'STORE'; rec.typeName = 'åº—èˆ—è³¼å…¥'; } 
                else if (rec.orderId) { rec.type = 'TC'; rec.typeName = 'é€šè²©/TCæ³¨æ–‡'; } 
                else { rec.type = 'OTHER'; rec.typeName = 'ãã®ä»–'; }
                records.push(rec);
            }
        };

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const dateMatch = line.match(dateRegex);
            if (dateMatch) {
                let isExpiryDate = false;
                if (currentRecord && currentRecord.pointsStr) {
                    const tempPoints = parseInt(currentRecord.pointsStr.replace(/,/g, ''), 10);
                    if (tempPoints > 0 && !currentRecord.expiryDate) isExpiryDate = true;
                }
                if (isExpiryDate) {
                    currentRecord.expiryDate = line;
                } else {
                    pushRecord(currentRecord);
                    currentRecord = { 
                        date: line, 
                        year: parseInt(dateMatch[1]), 
                        month: parseInt(dateMatch[2]), 
                        orderId: '', 
                        pointsStr: '', 
                        remarks: '', 
                        expiryDate: '' 
                    };
                }
            } else if (currentRecord) {
                if (line.match(pointRegex)) currentRecord.pointsStr = line;
                else if (line.match(orderIdRegex)) currentRecord.orderId = line;
                else currentRecord.remarks += (currentRecord.remarks ? ' ' : '') + line;
            }
        }
        pushRecord(currentRecord);
        return records;
    }

    function setupYearFilter(data) {
        const currentSelection = document.getElementById('yearFilter').value;
        const years = [...new Set(data.map(d => d.year))].sort((a, b) => b - a);
        const select = document.getElementById('yearFilter');
        select.innerHTML = '<option value="all">å…¨ã¦ã®æœŸé–“</option>';
        years.forEach(y => {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = y + 'å¹´';
            select.appendChild(option);
        });
        if (years.some(y => y.toString() === currentSelection)) select.value = currentSelection;
    }

    function applyFilters() {
        const yearVal = document.getElementById('yearFilter').value;
        const typeFilter = document.getElementById('typeFilter');
        const typeVal = typeFilter ? typeFilter.value : 'all';
        const filtered = allData.filter(item => {
            const yearMatch = yearVal === 'all' || item.year.toString() === yearVal;
            const typeMatch = typeVal === 'all' || item.type === typeVal;
            return yearMatch && typeMatch;
        });
        updateDashboard(filtered);
        renderTable(filtered);
    }

    function updateDashboard(data) {
        let gained = 0;
        let used = 0;
        data.forEach(d => {
            if (d.points > 0) gained += d.points;
            else used += Math.abs(d.points);
        });
        document.getElementById('totalGained').textContent = '+' + gained.toLocaleString();
        document.getElementById('totalUsed').textContent = '-' + used.toLocaleString();
        const net = gained - used;
        const sign = net > 0 ? '+' : '';
        document.getElementById('netBalance').textContent = sign + net.toLocaleString() + ' pt';
        document.getElementById('recordCount').textContent = data.length + ' ä»¶';
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.forEach(item => {
            const tr = document.createElement('tr');
            let tagClass = 'tag-other';
            if (item.type === 'STORE') tagClass = 'tag-store';
            if (item.type === 'TC') tagClass = 'tag-tc';
            if (item.type === 'EVENT') tagClass = 'tag-event';
            if (item.type === 'USE') tagClass = 'tag-use';
            const pointClass = item.points > 0 ? 'plus' : 'minus';
            const pointDisplay = (item.points > 0 ? '+' : '') + item.points.toLocaleString();
            tr.innerHTML = `
                <td>${item.date}</td>
                <td><span class="tag ${tagClass}">${item.typeName}</span></td>
                <td>${item.remarks || '-'}</td>
                <td>${item.orderId || '-'}</td>
                <td class="num ${pointClass}"><strong>${pointDisplay}</strong></td>
            `;
            tbody.appendChild(tr);
        });
    }
</script>

</body>
</html>
